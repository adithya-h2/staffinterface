<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Clara AI Receptionist - Sai Vidya Institute of Technology</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .institute-logo {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.5rem;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        .chat-container {
            height: 500px;
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.clara {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
            border-bottom-right-radius: 5px;
        }

        .message.clara .message-content {
            background: #e9ecef;
            color: #333;
            border-bottom-left-radius: 5px;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            margin: 0 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
        }

        .message.user .message-avatar {
            background: #28a745;
        }

        .message.clara .message-avatar {
            background: #667eea;
        }

        .chat-input {
            display: flex;
            gap: 10px;
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 25px;
            font-size: 16px;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input input:focus {
            border-color: #667eea;
        }

        .chat-input button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .chat-input button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }

        .call-offer {
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }

        .call-offer h3 {
            color: #1976d2;
            margin-bottom: 15px;
        }

        .call-offer p {
            margin-bottom: 20px;
            color: #424242;
        }

        .call-actions {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .video-call-interface {
            display: none;
        }

        .video-call-interface.active {
            display: block;
        }

        .video-container {
            background: #000;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
            min-height: 300px;
            margin-bottom: 20px;
        }

        .video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            height: 100%;
        }

        .video-wrapper {
            position: relative;
            background: #1a1a1a;
            border-radius: 10px;
            overflow: hidden;
        }

        .video-wrapper video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-label {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 12px;
        }

        .call-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }

        .control-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 12px 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .control-btn:hover {
            background: rgba(255,255,255,0.2);
            border-color: rgba(255,255,255,0.5);
        }

        .control-btn.active {
            background: #28a745;
            border-color: #28a745;
        }

        .appointment-booking {
            display: none;
        }

        .appointment-booking.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .qr-code-section {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            margin-top: 20px;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin: 20px auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: #666;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
        }

        .status.connecting {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status.connected {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .video-grid {
                grid-template-columns: 1fr;
            }
            
            .call-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="institute-logo">SV</div>
            <h1>üéì Clara AI Receptionist</h1>
            <p>Welcome to Sai Vidya Institute of Technology</p>
            <p>How can I assist you today?</p>
        </div>

        <div class="main-content">
            <!-- Chat Interface -->
            <div class="card">
                <h2>üí¨ Chat with Clara</h2>
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages">
                        <div class="message clara">
                            <div class="message-avatar">C</div>
                            <div class="message-content">
                                Hello! I'm Clara, your AI receptionist at Sai Vidya Institute of Technology. I'm here to help you with information about our staff members, their schedules, and arranging meetings. How can I assist you today?
                            </div>
                        </div>
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="messageInput" placeholder="Type your message here..." maxlength="500">
                        <button id="sendBtn">Send</button>
                    </div>
                </div>
            </div>

            <!-- Call Management -->
            <div class="card">
                <h2>üìû Call Management</h2>
                
                <!-- Call Offer Section -->
                <div id="callOfferSection" class="call-offer hidden">
                    <h3 id="callOfferTitle">Video Call Request</h3>
                    <p id="callOfferMessage">Would you like to start a video call?</p>
                    <div class="call-actions">
                        <button class="btn btn-success" id="acceptCallBtn">‚úÖ Accept Call</button>
                        <button class="btn btn-secondary" id="declineCallBtn">‚ùå Decline</button>
                    </div>
                </div>

                <!-- Video Call Interface -->
                <div id="videoCallInterface" class="video-call-interface">
                    <div class="video-container">
                        <div class="video-grid">
                            <div class="video-wrapper">
                                <video id="localVideo" autoplay muted playsinline></video>
                                <div class="video-label">You</div>
                            </div>
                            <div class="video-wrapper">
                                <video id="remoteVideo" autoplay playsinline></video>
                                <div class="video-label">Staff Member</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="call-controls">
                        <button class="control-btn" id="muteBtn">üîá Mute</button>
                        <button class="control-btn" id="videoBtn">üìπ Video</button>
                        <button class="control-btn btn-danger" id="endCallBtn">‚ùå End Call</button>
                    </div>
                </div>

                <!-- Appointment Booking -->
                <div id="appointmentBooking" class="appointment-booking">
                    <h3>üìÖ Book Appointment</h3>
                    <form id="appointmentForm">
                        <div class="form-group">
                            <label for="appointmentDate">Preferred Date</label>
                            <input type="date" id="appointmentDate" required>
                        </div>
                        <div class="form-group">
                            <label for="appointmentTime">Preferred Time</label>
                            <select id="appointmentTime" required>
                                <option value="">Select time</option>
                                <option value="09:00">9:00 AM</option>
                                <option value="10:00">10:00 AM</option>
                                <option value="11:00">11:00 AM</option>
                                <option value="14:00">2:00 PM</option>
                                <option value="15:00">3:00 PM</option>
                                <option value="16:00">4:00 PM</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="appointmentPurpose">Purpose</label>
                            <textarea id="appointmentPurpose" rows="3" required placeholder="Briefly describe the purpose of your visit"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Book Appointment</button>
                    </form>
                </div>

                <!-- QR Code Section -->
                <div id="qrCodeSection" class="qr-code-section hidden">
                    <h3>‚úÖ Appointment Confirmed!</h3>
                    <p>Your appointment has been successfully booked. Here's your QR code:</p>
                    <div class="qr-code" id="qrCode">
                        QR Code
                    </div>
                    <p>Scan this QR code with your mobile device to view appointment details.</p>
                    <button class="btn btn-secondary" id="newConversationBtn">Start New Conversation</button>
                </div>

                <!-- Status Display -->
                <div id="statusDisplay" class="status hidden"></div>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        class ClaraReception {
            constructor() {
                this.socket = null;
                this.localStream = null;
                this.peerConnection = null;
                this.currentCallId = null;
                this.isMuted = false;
                this.isVideoEnabled = true;
                this.currentStaff = null;
                this.conversationId = null;
                
                this.initializeSocket();
                this.bindEvents();
                this.generateConversationId();
            }

            initializeSocket() {
                this.socket = io();
                
                this.socket.on('connect', () => {
                    console.log('Connected to Clara AI server');
                    this.updateStatus('Connected to Clara AI', 'connected');
                });

                this.socket.on('disconnect', () => {
                    console.log('Disconnected from server');
                    this.updateStatus('Disconnected from server', 'error');
                });

                this.socket.on('clara-response', (data) => {
                    this.displayClaraMessage(data.response);
                    
                    if (data.callOffer) {
                        this.showCallOffer(data.callOffer);
                    }
                });

                this.socket.on('call-accepted', async (data) => {
                    // Legacy support: treat as start-call
                    await this.handleStartCall(data);
                });

                // New unified event to begin WebRTC after staff accepts
                this.socket.on('start-call', async (data) => {
                    await this.handleStartCall(data);
                });

                this.socket.on('call-ended', (data) => {
                    console.log('Call ended:', data);
                    this.updateStatus(`Call ended: ${data.reason}`, 'error');
                    this.cleanupCall();
                    // Don't show appointment booking immediately - wait for staff decision
                    this.updateStatus('Waiting for staff decision on appointment...', 'info');
                });

                this.socket.on('appointment_decision', (data) => {
                    console.log('Appointment decision received:', data);
                    if (data.approved) {
                        this.updateStatus('Appointment approved! Generating QR code...', 'success');
                    } else {
                        this.updateStatus('Appointment rejected. Please contact us for alternative arrangements.', 'error');
                        // Start new conversation after rejection
                        setTimeout(() => {
                            this.startNewConversation();
                        }, 3000);
                    }
                });

                this.socket.on('qr_code_generated', async (data) => {
                    console.log('QR code generated:', data);
                    try {
                        // Generate QR code image
                        const qrCodeElement = document.getElementById('qrCode');
                        await QRCode.toCanvas(qrCodeElement, data.qrCodeData, {
                            width: 180,
                            margin: 2
                        });

                        // Show QR code section
                        document.getElementById('qrCodeSection').classList.remove('hidden');
                        
                        // Update status
                        this.updateStatus('Appointment confirmed! QR code generated successfully.', 'success');
                        
                        // Start new conversation after showing QR code
                        setTimeout(() => {
                            this.startNewConversation();
                        }, 5000);
                        
                    } catch (error) {
                        console.error('Error generating QR code:', error);
                        this.updateStatus('Error generating QR code. Please try again.', 'error');
                    }
                });

                this.socket.on('offer', (data) => {
                    this.handleOffer(data.offer, data.from);
                });

                this.socket.on('answer', (data) => {
                    this.handleAnswer(data.answer, data.from);
                });

                this.socket.on('ice-candidate', (data) => {
                    this.handleIceCandidate(data.candidate, data.from);
                });

                this.socket.on('signaling-error', (data) => {
                    this.updateStatus(`Signaling error: ${data.message}`, 'error');
                });
            }

            bindEvents() {
                document.getElementById('sendBtn').addEventListener('click', () => {
                    this.sendMessage();
                });

                document.getElementById('messageInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        this.sendMessage();
                    }
                });

                document.getElementById('acceptCallBtn').addEventListener('click', () => {
                    this.acceptCall();
                });

                document.getElementById('declineCallBtn').addEventListener('click', () => {
                    this.declineCall();
                });

                document.getElementById('muteBtn').addEventListener('click', () => {
                    this.toggleMute();
                });

                document.getElementById('videoBtn').addEventListener('click', () => {
                    this.toggleVideo();
                });

                document.getElementById('endCallBtn').addEventListener('click', () => {
                    this.endCall();
                });

                document.getElementById('appointmentForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.bookAppointment();
                });

                document.getElementById('newConversationBtn').addEventListener('click', () => {
                    this.startNewConversation();
                });
            }

            generateConversationId() {
                this.conversationId = 'conv_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            }

            sendMessage() {
                const input = document.getElementById('messageInput');
                const message = input.value.trim();
                
                if (!message) return;

                // Display user message
                this.displayUserMessage(message);
                
                // Clear input
                input.value = '';

                // Send to Clara AI
                this.socket.emit('chat-message', {
                    message: message,
                    conversationId: this.conversationId
                });

                // Show typing indicator
                this.showTypingIndicator();
            }

            displayUserMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message user';
                messageDiv.innerHTML = `
                    <div class="message-avatar">U</div>
                    <div class="message-content">${this.escapeHtml(message)}</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            displayClaraMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message clara';
                messageDiv.innerHTML = `
                    <div class="message-avatar">C</div>
                    <div class="message-content">${this.escapeHtml(message)}</div>
                `;
                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            showTypingIndicator() {
                const chatMessages = document.getElementById('chatMessages');
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message clara typing';
                typingDiv.id = 'typingIndicator';
                typingDiv.innerHTML = `
                    <div class="message-avatar">C</div>
                    <div class="message-content">
                        <div class="typing-dots">
                            <span></span><span></span><span></span>
                        </div>
                    </div>
                `;
                chatMessages.appendChild(typingDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
            }

            showCallOffer(callOffer) {
                if (callOffer.canCall) {
                    this.currentStaff = callOffer.staff;
                    document.getElementById('callOfferTitle').textContent = `Video Call with ${callOffer.staff.name}`;
                    document.getElementById('callOfferMessage').textContent = callOffer.message;
                    document.getElementById('callOfferSection').classList.remove('hidden');
                } else {
                    this.displayClaraMessage(`I'm sorry, but ${callOffer.staff.name} is currently ${callOffer.reason.toLowerCase()}. ${callOffer.alternative}`);
                }
            }

            acceptCall() {
                if (!this.currentStaff) return;

                console.log('üìû Client: Sending call-request to server (no media yet)');
                document.getElementById('callOfferSection').classList.add('hidden');
                this.updateStatus('Request sent. Waiting for staff to accept...', 'connecting');

                // Emit a minimal call-request; media capture happens after server approves
                this.socket.emit('call-request', {
                    staffEmail: this.currentStaff.email,
                    staffId: this.currentStaff.id || this.currentStaff._id,
                    clientName: 'Client',
                    clientId: this.conversationId
                });
            }

            declineCall() {
                document.getElementById('callOfferSection').classList.add('hidden');
                this.displayClaraMessage("No problem! Is there anything else I can help you with?");
            }

            async startVideoCall() {
                try {
                    console.log('üé• Client: Requesting camera and microphone access...');
                    console.log('üìç Client Origin:', window.location.origin);
                    console.log('üîí Client Secure context:', window.isSecureContext);
                    
                    // Show connecting status
                    this.updateStatus('Requesting camera access...', 'connecting');
                    
                    // Request media with secure constraints
                    const constraints = {
                        video: {
                            width: { ideal: 1280 },
                            height: { ideal: 720 },
                            facingMode: 'user'
                        },
                        audio: {
                            echoCancellation: true,
                            noiseSuppression: true,
                            autoGainControl: true
                        }
                    };

                    this.localStream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    console.log('‚úÖ Client: Camera permission granted');
                    console.log('‚úÖ Client: Microphone permission granted');
                    console.log('‚úÖ Client: Local stream started successfully');
                    console.log('üìπ Client: Video tracks:', this.localStream.getVideoTracks().length);
                    console.log('üé§ Client: Audio tracks:', this.localStream.getAudioTracks().length);

                    const localVideo = document.getElementById('localVideo');
                    localVideo.srcObject = this.localStream;
                    localVideo.muted = true; // Prevent echo
                    await localVideo.play();
                    
                    console.log('‚úÖ Client: Local video element attached and playing');

                    document.getElementById('videoCallInterface').classList.add('active');
                    document.getElementById('statusDisplay').classList.add('hidden');
                    this.updateStatus('Connecting to staff...', 'connecting');

                    this.initializeWebRTC();
                } catch (error) {
                    console.error('‚ùå Client: Error accessing camera/microphone:', error);
                    console.error('Error name:', error.name);
                    console.error('Error message:', error.message);
                    
                    let errorMessage = 'Failed to access camera/microphone';
                    
                    if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMessage = 'Camera access denied. Please allow camera access and refresh the page.';
                    } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                        errorMessage = 'No camera or microphone found. Please connect a camera.';
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMessage = 'Camera is already in use. Please close other apps using the camera.';
                    } else if (error.name === 'OverconstrainedError') {
                        errorMessage = 'Camera settings not supported. Trying with default settings...';
                        // Retry with simpler constraints
                        try {
                            this.localStream = await navigator.mediaDevices.getUserMedia({
                                video: true,
                                audio: true
                            });
                            const localVideo = document.getElementById('localVideo');
                            localVideo.srcObject = this.localStream;
                            localVideo.muted = true;
                            await localVideo.play();
                            document.getElementById('videoCallInterface').classList.add('active');
                            document.getElementById('statusDisplay').classList.add('hidden');
                            this.initializeWebRTC();
                            return;
                        } catch (retryError) {
                            errorMessage = 'Failed to access camera even with basic settings.';
                        }
                    } else if (error.name === 'NotSupportedError') {
                        errorMessage = 'Video calls not supported. Please use Chrome, Edge, or Firefox.';
                    } else if (error.name === 'TypeError') {
                        errorMessage = 'Video calls require HTTPS. Please use a secure connection.';
                    }
                    
                    this.updateStatus(errorMessage, 'error');
                    
                    // Show error message in chat
                    this.displayClaraMessage(`‚ö†Ô∏è ${errorMessage} Please check your browser settings and try again.`);
                }
            }

            initializeWebRTC() {
                console.log('üîó Client: Initializing WebRTC peer connection...');
                
                const configuration = {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' },
                        { urls: 'stun:stun3.l.google.com:19302' }
                    ],
                    iceCandidatePoolSize: 10
                };

                this.peerConnection = new RTCPeerConnection(configuration);
                console.log('‚úÖ Client: Peer connection created');

                this.localStream.getTracks().forEach(track => {
                    this.peerConnection.addTrack(track, this.localStream);
                    console.log('üìπ Client: Added track to peer connection:', track.kind, track.label);
                });

                this.peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        console.log('üßä Client: Sending ICE candidate');
                        this.socket.emit('ice-candidate', {
                            candidate: event.candidate,
                            callId: this.currentCallId
                        });
                    } else {
                        console.log('‚úÖ Client: All ICE candidates sent');
                    }
                };

                this.peerConnection.ontrack = (event) => {
                    console.log('üìû Client: Received remote stream track:', event.track.kind);
                    const remoteVideo = document.getElementById('remoteVideo');
                    if (remoteVideo.srcObject !== event.streams[0]) {
                        remoteVideo.srcObject = event.streams[0];
                        remoteVideo.play();
                        console.log('‚úÖ Client: Remote video element attached');
                    }
                };

                this.peerConnection.onconnectionstatechange = () => {
                    const state = this.peerConnection.connectionState;
                    console.log('üîó Client: Connection state:', state);
                    
                    if (state === 'connected') {
                        console.log('‚úÖ Client: Peer connection established successfully');
                        this.updateStatus('Connected', 'success');
                    } else if (state === 'failed') {
                        console.warn('‚ö†Ô∏è Client: Connection failed');
                        this.updateStatus('Connection failed', 'error');
                    } else if (state === 'disconnected') {
                        console.warn('‚ö†Ô∏è Client: Connection disconnected');
                        this.updateStatus('Disconnected', 'error');
                    }
                };

                this.peerConnection.oniceconnectionstatechange = () => {
                    console.log('üßä Client: ICE connection state:', this.peerConnection.iceConnectionState);
                };

                console.log('‚úÖ Client: WebRTC initialized');
                // Do not create the offer here; wait until server confirms call-accepted with callId
            }

            async createOffer() {
                try {
                    const offer = await this.peerConnection.createOffer();
                    await this.peerConnection.setLocalDescription(offer);
                    
                    this.socket.emit('offer', {
                        offer: offer,
                        callId: this.currentCallId
                    });
                } catch (error) {
                    console.error('Error creating offer:', error);
                }
            }

            async handleOffer(offer, from) {
                try {
                    if (!this.peerConnection) {
                        this.initializeWebRTC();
                    }

                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                    const answer = await this.peerConnection.createAnswer();
                    await this.peerConnection.setLocalDescription(answer);

                    this.socket.emit('answer', {
                        answer: answer,
                        callId: this.currentCallId
                    });
                } catch (error) {
                    console.error('Error handling offer:', error);
                }
            }

            async handleAnswer(answer, from) {
                try {
                    await this.peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                } catch (error) {
                    console.error('Error handling answer:', error);
                }
            }

            async handleIceCandidate(candidate, from) {
                try {
                    if (this.peerConnection) {
                        await this.peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                } catch (error) {
                    console.error('Error handling ICE candidate:', error);
                }
            }

            toggleMute() {
                if (this.localStream) {
                    const audioTrack = this.localStream.getAudioTracks()[0];
                    if (audioTrack) {
                        audioTrack.enabled = !audioTrack.enabled;
                        this.isMuted = !audioTrack.enabled;
                        
                        const muteBtn = document.getElementById('muteBtn');
                        muteBtn.textContent = this.isMuted ? 'üîä Unmute' : 'üîá Mute';
                    }
                }
            }

            toggleVideo() {
                if (this.localStream) {
                    const videoTrack = this.localStream.getVideoTracks()[0];
                    if (videoTrack) {
                        videoTrack.enabled = !videoTrack.enabled;
                        this.isVideoEnabled = videoTrack.enabled;
                        
                        const videoBtn = document.getElementById('videoBtn');
                        videoBtn.textContent = this.isVideoEnabled ? 'üìπ Video' : 'üö´ No Video';
                    }
                }
            }

            endCall() {
                if (this.currentCallId) {
                    this.socket.emit('end-call', {
                        callId: this.currentCallId,
                        reason: 'Ended by client'
                    });
                }
                this.cleanupCall();
            }

            cleanupCall() {
                if (this.localStream) {
                    this.localStream.getTracks().forEach(track => track.stop());
                    this.localStream = null;
                }

                if (this.peerConnection) {
                    this.peerConnection.close();
                    this.peerConnection = null;
                }

                document.getElementById('videoCallInterface').classList.remove('active');
                document.getElementById('localVideo').srcObject = null;
                document.getElementById('remoteVideo').srcObject = null;

                this.currentCallId = null;
            }

            showAppointmentBooking() {
                document.getElementById('appointmentBooking').classList.add('active');
            }

            async bookAppointment() {
                const date = document.getElementById('appointmentDate').value;
                const time = document.getElementById('appointmentTime').value;
                const purpose = document.getElementById('appointmentPurpose').value;

                if (!date || !time || !purpose) {
                    alert('Please fill in all fields');
                    return;
                }

                try {
                    // Generate QR code
                    const qrData = {
                        staffName: this.currentStaff.name,
                        date: date,
                        time: time,
                        purpose: purpose,
                        appointmentId: 'APT' + Date.now()
                    };

                    const qrCodeData = JSON.stringify(qrData);
                    
                    // Generate QR code image
                    const qrCodeElement = document.getElementById('qrCode');
                    await QRCode.toCanvas(qrCodeElement, qrCodeData, {
                        width: 180,
                        margin: 2
                    });

                    // Show QR code section
                    document.getElementById('appointmentBooking').classList.remove('active');
                    document.getElementById('qrCodeSection').classList.remove('hidden');

                    // Store appointment in database
                    this.socket.emit('book-appointment', {
                        staffId: this.currentStaff.id,
                        date: date,
                        time: time,
                        purpose: purpose,
                        qrCodeData: qrCodeData
                    });

                } catch (error) {
                    console.error('Error booking appointment:', error);
                    alert('Error booking appointment. Please try again.');
                }
            }

            startNewConversation() {
                // Reset everything
                this.generateConversationId();
                this.currentStaff = null;
                
                // Clear chat
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = `
                    <div class="message clara">
                        <div class="message-avatar">C</div>
                        <div class="message-content">
                            Hello! I'm Clara, your AI receptionist at Sai Vidya Institute of Technology. I'm here to help you with information about our staff members, their schedules, and arranging meetings. How can I assist you today?
                        </div>
                    </div>
                `;

                // Hide all sections
                document.getElementById('callOfferSection').classList.add('hidden');
                document.getElementById('videoCallInterface').classList.remove('active');
                document.getElementById('appointmentBooking').classList.remove('active');
                document.getElementById('qrCodeSection').classList.add('hidden');
                document.getElementById('statusDisplay').classList.add('hidden');

                // Clear form
                document.getElementById('appointmentForm').reset();
            }

            updateStatus(message, type) {
                const statusDiv = document.getElementById('statusDisplay');
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.classList.remove('hidden');
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Helper to start call once server authorizes (start-call or call-accepted legacy)
        ClaraReception.prototype.handleStartCall = async function(data) {
            try {
                if (data && data.callId) {
                    this.currentCallId = data.callId;
                    console.log('üìû Client: Linked to call session:', this.currentCallId);
                } else {
                    console.warn('‚ö†Ô∏è Client: start-call without callId');
                }
                this.updateStatus(`Connecting to ${data.staffName || 'staff'}...`, 'connecting');
                await this.startVideoCall();
                await this.createOffer();
            } catch (err) {
                console.error('Failed to begin WebRTC after start-call:', err);
                this.updateStatus('Failed to start the call', 'error');
            }
        };

        // Initialize Clara Reception when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new ClaraReception();
        });
    </script>
</body>
</html>
