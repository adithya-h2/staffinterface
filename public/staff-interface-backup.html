<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    <title>Staff Interface - Sai Vidya Institute</title>
    <script src="/socket.io/socket.io.js"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/framer-motion@10/dist/framer-motion.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar - Exact match to image */
        .sidebar {
            width: 280px;
            background: #1a1a2e;
            border-right: 1px solid #16213e;
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid #16213e;
            margin-bottom: 2rem;
        }

        .profile {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .profile-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .profile-info h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: white;
        }

        .profile-info p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .nav-menu {
            list-style: none;
            padding: 0 1rem;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            color: #cbd5e1;
            text-decoration: none;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .nav-link:hover {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .nav-link.active {
            background: #22d3ee;
            color: #0f172a;
        }

        .nav-link i {
            font-size: 1.125rem;
            width: 20px;
        }

        /* Main Content - Exact match to image */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
            background: #0f172a;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #16213e;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            color: white;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
            font-weight: 500;
            background: rgba(34, 197, 94, 0.1);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.1);
            color: #cbd5e1;
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(148, 163, 184, 0.2);
        }

        /* Grid Layout - Exact 2x2 from image */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .card {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .card:hover {
            border-color: #22d3ee;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #16213e;
        }

        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: white;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: white;
            margin: 0;
        }

        .card-content {
            color: #cbd5e1;
            line-height: 1.6;
            min-height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Login Overlay */
        .login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .login-card {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 1.5rem;
            padding: 3rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .login-header h2 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: white;
        }

        .login-header p {
            color: #94a3b8;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #e2e8f0;
        }

        .form-group input {
            width: 100%;
            padding: 0.875rem 1rem;
            border: 1px solid #16213e;
            border-radius: 0.75rem;
            background: #0f172a;
            color: #e2e8f0;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-group input::placeholder {
            color: #64748b;
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .main-content {
                padding: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .card {
                padding: 1rem;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #3b82f6;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #2563eb;
        }

        /* Animation */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        /* Call Updates Specific Styles */
        .call-updates {
            min-height: 300px;
        }

        .call-updates .card-content {
            min-height: 250px;
            display: flex;
            flex-direction: column;
            align-items: stretch;
            justify-content: flex-start;
            padding: 0;
        }

        .call-updates-list {
            max-height: 250px;
            overflow-y: auto;
            padding: 10px;
        }

        .call-update-item {
            background: #16213e;
            border: 1px solid #1e293b;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
        }

        .call-update-item:hover {
            background: #1e293b;
            border-color: #3b82f6;
        }

        .call-update-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }

        .call-update-icon.incoming {
            background: #10b981;
        }

        .call-update-icon.accepted {
            background: #3b82f6;
        }

        .call-update-icon.declined {
            background: #ef4444;
        }

        .call-update-content {
            flex: 1;
        }

        .call-update-title {
            font-weight: 600;
            color: white;
            margin: 0 0 4px 0;
            font-size: 14px;
        }

        .call-update-details {
            color: #94a3b8;
            font-size: 12px;
            margin: 0;
        }

        .call-update-time {
            color: #64748b;
            font-size: 11px;
            margin: 0;
        }

        /* Video Call Display Styles */
        .video-call-display {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-call-display.hidden {
            display: none;
        }

        .video-call-content {
            background: #1a1a2e;
            border: 1px solid #16213e;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5);
        }

        .video-call-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #16213e;
        }

        .video-call-header .caller-info h3 {
            color: white;
            margin: 0 0 5px 0;
            font-size: 18px;
        }

        .video-call-header .caller-info p {
            color: #94a3b8;
            margin: 0;
            font-size: 14px;
        }

        .video-container {
            background: #0f172a;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            border: 1px solid #16213e;
        }

        .video-placeholder {
            color: #cbd5e1;
        }

        .video-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .video-placeholder p {
            margin: 5px 0;
            font-size: 16px;
        }

        #videoCallStatus {
            color: #10b981;
            font-weight: 600;
        }

        /* Timetable Grid Styles - Exact Match to Image */
        .timetable-grid {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
            background: #ffffff;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: block !important;
            visibility: visible !important;
        }

        .timetable-header {
            display: grid;
            grid-template-columns: 100px repeat(9, 1fr);
            gap: 0;
            margin-bottom: 0;
        }

        .timetable-body {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .day-row {
            display: grid;
            grid-template-columns: 100px repeat(9, 1fr);
            gap: 0;
        }

        .time-header {
            background: #4a5568;
            color: #ffffff;
            padding: 12px 8px;
            text-align: center;
            font-weight: 700;
            border: 1px solid #2d3748;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }

        .time-slot {
            background: #4a5568;
            color: #ffffff;
            padding: 12px 8px;
            text-align: center;
            font-weight: 700;
            border: 1px solid #2d3748;
            font-size: 0.75rem;
            letter-spacing: 0.3px;
        }

        .day-name {
            background: #4a5568;
            color: #ffffff;
            padding: 12px 8px;
            text-align: center;
            font-weight: 700;
            border: 1px solid #2d3748;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .day-slot {
            background: #f7fafc;
            color: #4a5568;
            padding: 12px 8px;
            text-align: center;
            border: 1px solid #e2e8f0;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 0.8rem;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            position: relative;
        }

        .day-slot:hover {
            background: #edf2f7;
            color: #2d3748;
            transform: scale(1.02);
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .day-slot.coffee-break {
            background: #fbbf24;
            color: #1f2937;
            font-weight: 700;
            cursor: default;
        }

        .day-slot.coffee-break:hover {
            background: #f59e0b;
            transform: none;
            box-shadow: none;
        }

        .day-slot.lunch-break {
            background: #f59e0b;
            color: #1f2937;
            font-weight: 700;
            cursor: default;
        }

        .day-slot.lunch-break:hover {
            background: #d97706;
            transform: none;
            box-shadow: none;
        }

        .day-slot.has-subject {
            background: #667eea;
            color: #ffffff;
            font-weight: 600;
            border: 2px solid #5a67d8;
        }

        .day-slot.has-subject:hover {
            background: #5a67d8;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .day-slot.has-subject::after {
            content: '‚úèÔ∏è';
            position: absolute;
            top: 4px;
            right: 4px;
            font-size: 0.7rem;
            opacity: 0.7;
        }

        .day-slot.empty-slot {
            background: #f7fafc;
            color: #a0aec0;
            font-style: italic;
        }

        .day-slot.empty-slot:hover {
            background: #edf2f7;
            color: #4a5568;
            font-style: normal;
        }

        /* Animation keyframes */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        /* Enhanced timetable display */
        .timetable-container {
            background: #ffffff;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: block !important;
            visibility: visible !important;
        }

        .timetable-header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .timetable-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
            margin: 0;
        }

        .timetable-actions {
            display: flex;
            gap: 0.75rem;
        }

        .btn-refresh {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .btn-refresh:hover {
            background: #5a67d8;
            transform: translateY(-1px);
        }

        .btn-clear {
            background: #e53e3e;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .btn-clear:hover {
            background: #c53030;
            transform: translateY(-1px);
        }

        /* iOS-style Call Notification */
        .call-notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 320px;
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            animation: slideInUp 0.3s ease;
            border: 1px solid #e2e8f0;
        }

        .call-notification.hidden {
            display: none;
        }

        .call-notification-content {
            padding: 20px;
        }

        .call-notification-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .caller-avatar {
            width: 50px;
            height: 50px;
            background: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }

        .caller-info h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
            color: #2d3748;
        }

        .caller-info p {
            margin: 4px 0 0 0;
            font-size: 14px;
            color: #718096;
        }

        .call-notification-actions {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .call-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .call-btn.decline {
            background: #e53e3e;
            color: white;
        }

        .call-btn.decline:hover {
            background: #c53030;
            transform: scale(1.05);
        }

        .call-btn.accept {
            background: #48bb78;
            color: white;
        }

        .call-btn.accept:hover {
            background: #38a169;
            transform: scale(1.05);
        }

        @keyframes slideInUp {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Responsive timetable */
        @media (max-width: 1200px) {
            .timetable-header,
            .day-row {
                grid-template-columns: 70px repeat(9, 1fr);
            }
            
            .time-slot,
            .day-slot {
                font-size: 0.7rem;
                padding: 0.5rem 0.25rem;
            }
        }

        @media (max-width: 768px) {
            .timetable-grid {
                font-size: 0.75rem;
            }
            
            .timetable-header,
            .day-row {
                grid-template-columns: 60px repeat(9, 1fr);
            }
            
            .time-slot,
            .day-slot {
                font-size: 0.65rem;
                padding: 0.25rem;
                min-height: 30px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Overlay -->
        <div id="loginOverlay" class="login-overlay">
            <div class="login-card">
                <div class="login-header">
                    <h2>Staff Login</h2>
                    <p>Enter your credentials to access the dashboard</p>
                </div>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="Enter your email" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Enter your password" required>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Login</button>
                </form>
                <div class="credentials-list" style="margin-top: 20px; padding: 15px; background: #0f172a; border: 1px solid #16213e; border-radius: 8px;">
                    <h4 style="color: #22d3ee; margin-bottom: 10px;">Demo Credentials:</h4>
                    <div class="credential-item" style="padding: 5px 0; border-bottom: 1px solid #16213e; color: #94a3b8;">Email: anithacs@gmail.com | Password: demo123</div>
                    <div class="credential-item" style="padding: 5px 0; border-bottom: 1px solid #16213e; color: #94a3b8;">Email: lakshmidurga@gmail.com | Password: demo123</div>
                    <div class="credential-item" style="padding: 5px 0; color: #94a3b8;">Email: gdhivyasri@gmail.com | Password: demo123</div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="profile">
                    <div class="profile-avatar" id="profileAvatar">PS</div>
                    <div class="profile-info">
                        <h2 id="profileName">Prof. Anitha C S</h2>
                        <p id="profileDept">Computer Science</p>
                        <p id="profileBranch">Engineering</p>
                    </div>
                </div>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-tab="profile">
                            <i class="fas fa-user"></i>
                            Profile
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="settings">
                            <i class="fas fa-cog"></i>
                            Settings
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="team">
                            <i class="fas fa-users"></i>
                            Team Directory
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="tasks">
                            <i class="fas fa-tasks"></i>
                            Task Management
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="leave">
                            <i class="fas fa-calendar-times"></i>
                            Leave Requests
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-tab="resources">
                            <i class="fas fa-folder"></i>
                            Resources
                        </a>
                    </li>
                </ul>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h1>Staff Dashboard</h1>
                <div class="header-actions">
                    <div class="status-badge" id="connectionStatus">Connected</div>
                    <button class="btn btn-secondary" id="logoutBtn">Logout</button>
                </div>
            </div>

            <!-- Dashboard Grid - Exact 2x2 layout from image -->
            <div class="dashboard-grid">
                <!-- Weekly Timetable -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon" style="background: #3b82f6;">
                            <i class="fas fa-calendar"></i>
                        </div>
                        <h2 class="card-title">Weekly Timetable</h2>
                    </div>
                    <div class="card-content">
                        <div class="timetable-container">
                            <div class="timetable-header-section">
                                <h3 class="timetable-title">Class Schedule</h3>
                                <div class="timetable-actions">
                                    <button class="btn-refresh" onclick="loadTimetableData()">
                                        <i class="fas fa-sync-alt"></i> Refresh
                                    </button>
                                    <button class="btn-clear" onclick="clearAllTimetableEntries()">
                                        <i class="fas fa-trash"></i> Clear All
                                    </button>
                                </div>
                            </div>
                            <div id="timetableGrid" class="timetable-grid">
                            <div class="timetable-header">
                                <div class="time-header">Time</div>
                                <div class="time-slot">8:30 - 9:25</div>
                                <div class="time-slot">9:25 - 10:20</div>
                                <div class="time-slot">10:20 - 10:40</div>
                                <div class="time-slot">10:40 - 11:35</div>
                                <div class="time-slot">11:35 - 12:30</div>
                                <div class="time-slot">12:30 - 1:15</div>
                                <div class="time-slot">1:15 - 2:10</div>
                                <div class="time-slot">2:10 - 3:05</div>
                                <div class="time-slot">3:05 - 4:10</div>
                            </div>
                            <div class="timetable-body">
                                <div class="day-row">
                                    <div class="day-name">Monday</div>
                                    <div class="day-slot" data-day="Monday" data-time="8:30-9:25">Enter subject</div>
                                    <div class="day-slot" data-day="Monday" data-time="9:25-10:20">Enter subject</div>
                                    <div class="day-slot coffee-break" data-day="Monday" data-time="10:20-10:40">Coffee Break</div>
                                    <div class="day-slot" data-day="Monday" data-time="10:40-11:35">Enter subject</div>
                                    <div class="day-slot" data-day="Monday" data-time="11:35-12:30">Enter subject</div>
                                    <div class="day-slot lunch-break" data-day="Monday" data-time="12:30-1:15">Lunch Break</div>
                                    <div class="day-slot" data-day="Monday" data-time="1:15-2:10">Enter subject</div>
                                    <div class="day-slot" data-day="Monday" data-time="2:10-3:05">Enter subject</div>
                                    <div class="day-slot" data-day="Monday" data-time="3:05-4:10">Enter subject</div>
                                </div>
                                <div class="day-row">
                                    <div class="day-name">Tuesday</div>
                                    <div class="day-slot" data-day="Tuesday" data-time="8:30-9:25">Enter subject</div>
                                    <div class="day-slot" data-day="Tuesday" data-time="9:25-10:20">Enter subject</div>
                                    <div class="day-slot coffee-break" data-day="Tuesday" data-time="10:20-10:40">Coffee Break</div>
                                    <div class="day-slot" data-day="Tuesday" data-time="10:40-11:35">Enter subject</div>
                                    <div class="day-slot" data-day="Tuesday" data-time="11:35-12:30">Enter subject</div>
                                    <div class="day-slot lunch-break" data-day="Tuesday" data-time="12:30-1:15">Lunch Break</div>
                                    <div class="day-slot" data-day="Tuesday" data-time="1:15-2:10">Enter subject</div>
                                    <div class="day-slot" data-day="Tuesday" data-time="2:10-3:05">Enter subject</div>
                                    <div class="day-slot" data-day="Tuesday" data-time="3:05-4:10">Enter subject</div>
                                </div>
                                <div class="day-row">
                                    <div class="day-name">Wednesday</div>
                                    <div class="day-slot" data-day="Wednesday" data-time="8:30-9:25">Enter subject</div>
                                    <div class="day-slot" data-day="Wednesday" data-time="9:25-10:20">Enter subject</div>
                                    <div class="day-slot coffee-break" data-day="Wednesday" data-time="10:20-10:40">Coffee Break</div>
                                    <div class="day-slot" data-day="Wednesday" data-time="10:40-11:35">Enter subject</div>
                                    <div class="day-slot" data-day="Wednesday" data-time="11:35-12:30">Enter subject</div>
                                    <div class="day-slot lunch-break" data-day="Wednesday" data-time="12:30-1:15">Lunch Break</div>
                                    <div class="day-slot" data-day="Wednesday" data-time="1:15-2:10">Enter subject</div>
                                    <div class="day-slot" data-day="Wednesday" data-time="2:10-3:05">Enter subject</div>
                                    <div class="day-slot" data-day="Wednesday" data-time="3:05-4:10">Enter subject</div>
                                </div>
                                <div class="day-row">
                                    <div class="day-name">Thursday</div>
                                    <div class="day-slot" data-day="Thursday" data-time="8:30-9:25">Enter subject</div>
                                    <div class="day-slot" data-day="Thursday" data-time="9:25-10:20">Enter subject</div>
                                    <div class="day-slot coffee-break" data-day="Thursday" data-time="10:20-10:40">Coffee Break</div>
                                    <div class="day-slot" data-day="Thursday" data-time="10:40-11:35">Enter subject</div>
                                    <div class="day-slot" data-day="Thursday" data-time="11:35-12:30">Enter subject</div>
                                    <div class="day-slot lunch-break" data-day="Thursday" data-time="12:30-1:15">Lunch Break</div>
                                    <div class="day-slot" data-day="Thursday" data-time="1:15-2:10">Enter subject</div>
                                    <div class="day-slot" data-day="Thursday" data-time="2:10-3:05">Enter subject</div>
                                    <div class="day-slot" data-day="Thursday" data-time="3:05-4:10">Enter subject</div>
                                </div>
                                <div class="day-row">
                                    <div class="day-name">Friday</div>
                                    <div class="day-slot" data-day="Friday" data-time="8:30-9:25">Enter subject</div>
                                    <div class="day-slot" data-day="Friday" data-time="9:25-10:20">Enter subject</div>
                                    <div class="day-slot coffee-break" data-day="Friday" data-time="10:20-10:40">Coffee Break</div>
                                    <div class="day-slot" data-day="Friday" data-time="10:40-11:35">Enter subject</div>
                                    <div class="day-slot" data-day="Friday" data-time="11:35-12:30">Enter subject</div>
                                    <div class="day-slot lunch-break" data-day="Friday" data-time="12:30-1:15">Lunch Break</div>
                                    <div class="day-slot" data-day="Friday" data-time="1:15-2:10">Enter subject</div>
                                    <div class="day-slot" data-day="Friday" data-time="2:10-3:05">Enter subject</div>
                                    <div class="day-slot" data-day="Friday" data-time="3:05-4:10">Enter subject</div>
                                </div>
                                <div class="day-row">
                                    <div class="day-name">Saturday</div>
                                    <div class="day-slot" data-day="Saturday" data-time="8:30-9:25">Enter subject</div>
                                    <div class="day-slot" data-day="Saturday" data-time="9:25-10:20">Enter subject</div>
                                    <div class="day-slot coffee-break" data-day="Saturday" data-time="10:20-10:40">Coffee Break</div>
                                    <div class="day-slot" data-day="Saturday" data-time="10:40-11:35">Enter subject</div>
                                    <div class="day-slot" data-day="Saturday" data-time="11:35-12:30">Enter subject</div>
                                    <div class="day-slot lunch-break" data-day="Saturday" data-time="12:30-1:15">Lunch Break</div>
                                    <div class="day-slot" data-day="Saturday" data-time="1:15-2:10">Enter subject</div>
                                    <div class="day-slot" data-day="Saturday" data-time="2:10-3:05">Enter subject</div>
                                    <div class="day-slot" data-day="Saturday" data-time="3:05-4:10">Enter subject</div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Call Updates -->
                <div class="card call-updates">
                    <div class="card-header">
                        <div class="card-icon" style="background: #48bb78;">
                            <i class="fas fa-phone"></i>
                        </div>
                        <h2 class="card-title">Call Updates</h2>
                    </div>
                    <div id="callUpdatesContainer" class="card-content">
                        <!-- Call Updates Container will be rendered here -->
                    </div>
                </div>

                <!-- Call Log -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon" style="background: #f59e0b;">
                            <i class="fas fa-phone-alt"></i>
                        </div>
                        <h2 class="card-title">Call Log</h2>
                    </div>
                    <div class="card-content">
                        <p>Login to view call log</p>
                    </div>
                </div>

                <!-- Appointments -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-icon" style="background: #8b5cf6;">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <h2 class="card-title">Appointments</h2>
                    </div>
                    <div class="card-content">
                        <p>No appointments scheduled</p>
                    </div>
                </div>
            </div>

            <!-- Call Updates Container -->
            <div class="card call-updates">
                <div class="card-header">
                    <div class="card-icon" style="background: #10b981;">
                        <i class="fas fa-phone"></i>
                    </div>
                    <h2 class="card-title">Call Updates</h2>
                </div>
                <div class="card-content">
                    <div id="callUpdatesList" class="call-updates-list">
                        <div style="text-align: center; color: #64748b; padding: 20px;">
                            <i class="fas fa-phone-slash" style="font-size: 24px; margin-bottom: 8px;"></i>
                            <p>No call updates yet</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Font Awesome -->
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>

    <script>
        // Global variables
        let currentStaff = null;
        let socket = null;

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeSocket();
            setupEventListeners();
            checkAuthStatus();
        });

        // Socket initialization
        function initializeSocket() {
            socket = io();
            
            socket.on('connect', () => {
                updateConnectionStatus('Connected', 'connected');
            });

            socket.on('disconnect', () => {
                updateConnectionStatus('Disconnected', 'disconnected');
            });

            // Call event listeners
            socket.on('call_initiated', (data) => {
                console.log('Call initiated:', data);
            });

            socket.on('call_accepted', (data) => {
                console.log('Call accepted:', data);
            });

            socket.on('call_declined', (data) => {
                console.log('Call declined:', data);
            });

            socket.on('call_ended', (data) => {
                console.log('Call ended:', data);
            });

            // Timetable event listeners
            socket.on('timetable_entries', (data) => {
                console.log('Received timetable entries:', data);
                displayTimetableEntries(data.entries);
            });

            socket.on('timetable_entry_added', (data) => {
                console.log('Timetable entry added:', data);
                loadTimetableData();
            });

            socket.on('timetable_entry_updated', (data) => {
                console.log('Timetable entry updated:', data);
                loadTimetableData();
            });

            socket.on('timetable_entry_deleted', (data) => {
                console.log('Timetable entry deleted:', data);
                loadTimetableData();
            });

            socket.on('timetable_cleared', (data) => {
                console.log('Timetable cleared:', data);
                clearTimetableSlots();
                showNotification(data.message, 'info');
            });

            // New email-based call system event listeners
            socket.on('incoming-call', (data) => {
                console.log('üìû Incoming call:', data);
                showCallNotification(data);
            });

            socket.on('new-client', (data) => {
                console.log('üë§ New client connected:', data);
                showNotification(`New client connected: ${data.clientId}`, 'info');
            });

            socket.on('receive-message', (data) => {
                console.log('üí¨ Message received:', data);
                showNotification(`Message from ${data.clientId}: ${data.message}`, 'info');
            });

            // WebRTC call request handler
            socket.on('webrtc-call-request', (data) => {
                console.log('üé• WebRTC call request received:', data);
                console.log('üé• Call ID:', data.callId);
                console.log('üé• Client Name:', data.clientName);
                console.log('üé• Staff Email:', data.staffEmail);
                console.log('üé• Broadcast:', data.broadcast);
                
                // Show popup notification
                showWebRTCCallNotification(data);
                
                // Also add to call updates container
                addCallUpdate({
                    type: 'webrtc-call-request',
                    callId: data.callId,
                    clientName: data.clientName,
                    clientId: data.clientId,
                    staffEmail: data.staffEmail,
                    staffName: data.staffName,
                    timestamp: data.timestamp,
                    status: 'incoming'
                });
            });

            // Call updates handler
            socket.on('call-update', (data) => {
                console.log('üìû Call update received:', data);
                addCallUpdate(data);
            });

            // Handle incoming video call requests from client
            socket.on('video-call-request', (data) => {
                console.log('üé• Video call request received:', data);
                showCallNotification({
                    callId: data.requestId,
                    clientName: data.clientName,
                    clientId: data.clientId,
                    type: 'video-call'
                });
            });

            // Test function to add a sample call update (for debugging)
            window.testCallUpdate = function() {
                addCallUpdate({
                    type: 'webrtc-call-request',
                    callId: 'test_call_123',
                    clientName: 'Test Client',
                    clientId: 'test_client_123',
                    staffEmail: 'test@example.com',
                    staffName: 'Test Staff',
                    timestamp: new Date(),
                    status: 'incoming'
                });
            };

            // WebRTC call response handler
            socket.on('webrtc-call-response', (data) => {
                console.log('üìû WebRTC call response:', data);
                if (data.accepted) {
                    showNotification('WebRTC call accepted! Starting video call...', 'success');
                    // Show the GMeet-style video call interface
                    showVideoCallInterface({
                        callId: data.callId,
                        clientName: data.clientName || 'Client',
                        clientId: data.clientId
                    });
                } else {
                    showNotification('WebRTC call declined', 'info');
                }
            });

            // WebRTC signaling handlers
            socket.on('call_offer', async (data) => {
                try {
                    console.log('üìû Received call offer:', data);
                    if (peerConnection) {
                        await peerConnection.setRemoteDescription(data.offer);
                        const answer = await peerConnection.createAnswer();
                        await peerConnection.setLocalDescription(answer);
                        
                        socket.emit('call_answer', {
                            callId: data.callId,
                            answer: answer
                        });
                        console.log('üì§ WebRTC answer sent');
                    }
                } catch (error) {
                    console.error('‚ùå Error handling call offer:', error);
                }
            });

            // Staff is the answerer. Ignore call_answer unless staff created an offer (should not happen).
            socket.on('call_answer', async (data) => {
                try {
                    console.log('üìû Received call answer (staff side - normally ignored):', data);
                    if (peerConnection && peerConnection.signalingState === 'have-local-offer') {
                        await peerConnection.setRemoteDescription(data.answer);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Staff ignored call_answer due to signaling state:', peerConnection?.signalingState, error?.message);
                }
            });

            socket.on('ice_candidate', async (data) => {
                try {
                    console.log('üßä Received ICE candidate:', data);
                    if (peerConnection) {
                        await peerConnection.addIceCandidate(data.candidate);
                    }
                } catch (error) {
                    console.error('‚ùå Error handling ICE candidate:', error);
                }
            });
        }

        // Event listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
            
            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);
            
            // Tab navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchTab(link.dataset.tab);
                });
            });
        }

        // Authentication with permanent login
        function checkAuthStatus() {
            const token = localStorage.getItem('staffToken');
            const staffData = localStorage.getItem('staffData');
            
            if (token && staffData) {
                try {
                    // Parse stored staff data
                    currentStaff = JSON.parse(staffData);
                    
                    // Verify token is still valid (optional - for extra security)
                fetch('/api/auth/verify', {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                            // Token is valid, proceed with login
                        onStaffLoginSuccess();
                    } else {
                            // Token expired, but we'll still allow login with stored data
                            console.log('Token expired, but using stored staff data');
                            onStaffLoginSuccess();
                    }
                })
                .catch(() => {
                        // Network error, but we'll still allow login with stored data
                        console.log('Network error, but using stored staff data');
                        onStaffLoginSuccess();
                });
                } catch (error) {
                    console.error('Error parsing stored staff data:', error);
                    showLoginOverlay();
                }
            } else {
                showLoginOverlay();
            }
        }

        function handleLogin(e) {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            // Demo authentication
            const demoStaff = {
                'anithacs@gmail.com': { id: 'ACS', name: 'Prof. Anitha C S', dept: 'Computer Science', branch: 'Engineering', avatar: 'PS' },
                'lakshmidurga@gmail.com': { id: 'LDN', name: 'Prof. Lakshmi Durga N', dept: 'Computer Science', branch: 'Engineering', avatar: 'LD' },
                'gdhivyasri@gmail.com': { id: 'GD', name: 'Dr. G Dhivyasri', dept: 'Computer Science', branch: 'Engineering', avatar: 'GD' }
            };

            if (password === 'demo123' && demoStaff[email]) {
                currentStaff = demoStaff[email];
                
                // Store permanent login data
                localStorage.setItem('staffToken', 'demo-token-' + Date.now());
                localStorage.setItem('staffData', JSON.stringify(currentStaff));
                localStorage.setItem('permanentLogin', 'true');
                
                // Register this staff connection with the server so call routing works
                try {
                    if (socket && socket.connected) {
                        socket.emit('staff-login', { email, password });
                    }
                } catch (_) {}
                onStaffLoginSuccess();
            } else {
                alert('Invalid credentials. Please use the demo credentials provided.');
            }
        }

        function onStaffLoginSuccess() {
            hideLoginOverlay();
            updateProfileInfo();
            initializeCallUpdatesContainer();
            loadTimetableData();
            
            // Register staff with email-based system
            if (currentStaff && currentStaff.email) {
                socket.emit('register-staff', currentStaff.email);
                console.log(`üìß Staff registered with email: ${currentStaff.email}`);
            }
        }

        function handleLogout() {
            currentStaff = null;
            localStorage.removeItem('staffToken');
            localStorage.removeItem('staffData');
            localStorage.removeItem('permanentLogin');
            showLoginOverlay();
        }

        function showLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'flex';
        }

        function hideLoginOverlay() {
            document.getElementById('loginOverlay').style.display = 'none';
        }

        function updateProfileInfo() {
            if (currentStaff) {
                document.getElementById('profileName').textContent = currentStaff.name;
                document.getElementById('profileDept').textContent = currentStaff.dept;
                document.getElementById('profileBranch').textContent = currentStaff.branch;
                document.getElementById('profileAvatar').textContent = currentStaff.avatar;
            }
        }

        function updateConnectionStatus(status, type) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.textContent = status;
            statusElement.className = `status-badge ${type}`;
        }

        function switchTab(tabName) {
            // Remove active class from all nav links
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            
            // Add active class to clicked link
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            
            // Here you would typically show/hide different content sections
            console.log('Switched to tab:', tabName);
        }

        // Call Updates Container
        function initializeCallUpdatesContainer() {
            if (!currentStaff) return;

            const container = document.getElementById('callUpdatesContainer');
            if (!container) return;

            // Get JWT token from localStorage
            const jwtToken = localStorage.getItem('staffToken') || 'demo-token';

            // Render CallUpdatesWidget component
            const callUpdatesElement = React.createElement(CallUpdatesWidget, {
                staffId: currentStaff.id,
                jwtToken: jwtToken
            });

            ReactDOM.render(callUpdatesElement, container);
        }

        // Timetable functions
        function loadTimetableData() {
            console.log('Loading timetable data for staff:', currentStaff);
            if (currentStaff) {
                socket.emit('get_staff_timetable', { staffId: currentStaff.id });
                // Add a fallback to show the timetable even if no data
                setTimeout(() => {
                    const timetableGrid = document.getElementById('timetableGrid');
                    if (timetableGrid) {
                        console.log('Timetable grid found, ensuring visibility');
                        timetableGrid.style.display = 'block';
                        timetableGrid.style.visibility = 'visible';
                    } else {
                        console.log('Timetable grid not found!');
                    }
                }, 1000);
            } else {
                console.log('No current staff found');
            }
        }

        function displayTimetableEntries(entries) {
            if (!entries || entries.length === 0) {
                // Clear all slots except breaks
                clearTimetableSlots();
                return;
            }

            // Clear all slots first
            clearTimetableSlots();

            // Populate slots with actual data
            entries.forEach(entry => {
                const day = entry.day;
                const startTime = entry.timeSlot.start;
                const endTime = entry.timeSlot.end;
                const subject = entry.subject || entry.activity;
                const room = entry.room;
                
                // Find the corresponding slot
                const slot = document.querySelector(`[data-day="${day}"][data-time="${startTime}-${endTime}"]`);
                if (slot && !slot.classList.contains('coffee-break') && !slot.classList.contains('lunch-break')) {
                    slot.textContent = subject;
                    slot.classList.add('has-subject');
                    slot.title = `${subject}${room ? ` - ${room}` : ''}`;
                }
            });
        }

        function clearTimetableSlots() {
            const slots = document.querySelectorAll('.day-slot:not(.coffee-break):not(.lunch-break)');
            slots.forEach(slot => {
                slot.textContent = 'Enter subject';
                slot.classList.remove('has-subject');
                slot.title = '';
            });
        }

        // Enhanced timetable management functions
        function setupTimetableClickHandlers() {
            const slots = document.querySelectorAll('.day-slot:not(.coffee-break):not(.lunch-break)');
            slots.forEach(slot => {
                slot.addEventListener('click', function() {
                    const day = this.dataset.day;
                    const time = this.dataset.time;
                    const [startTime, endTime] = time.split('-');
                    const currentSubject = this.textContent;
                    
                    // Show enhanced modal for timetable entry
                    showTimetableModal(day, startTime, endTime, currentSubject, this);
                });
            });
        }

        function showTimetableModal(day, startTime, endTime, currentSubject, slotElement) {
            // Create modal overlay
            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;

            // Create modal content
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                padding: 2rem;
                border-radius: 12px;
                box-shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
                max-width: 500px;
                width: 90%;
                color: #1a202c;
            `;

            modalContent.innerHTML = `
                <h3 style="margin-bottom: 1.5rem; color: #2d3748; font-size: 1.25rem;">Timetable Entry</h3>
                <div style="margin-bottom: 1rem;">
                    <strong>Day:</strong> ${day}<br>
                    <strong>Time:</strong> ${startTime} - ${endTime}
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Subject:</label>
                    <input type="text" id="subjectInput" value="${currentSubject === 'Enter subject' ? '' : currentSubject}" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Room:</label>
                    <input type="text" id="roomInput" placeholder="e.g., Room 101, Lab 2" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 1rem;">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Batch/Semester:</label>
                    <input type="text" id="batchInput" placeholder="e.g., CSE 3rd Sem, Batch A" 
                           style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 6px; font-size: 1rem;">
                </div>
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button id="cancelBtn" style="padding: 0.75rem 1.5rem; border: 2px solid #e2e8f0; background: white; color: #4a5568; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
                    <button id="deleteBtn" style="padding: 0.75rem 1.5rem; border: 2px solid #e53e3e; background: white; color: #e53e3e; border-radius: 6px; cursor: pointer; font-weight: 600;">Delete</button>
                    <button id="saveBtn" style="padding: 0.75rem 1.5rem; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Save</button>
                </div>
            `;

            modalOverlay.appendChild(modalContent);
            document.body.appendChild(modalOverlay);

            // Focus on subject input
            const subjectInput = modalContent.querySelector('#subjectInput');
            subjectInput.focus();
            subjectInput.select();

            // Event handlers
            modalContent.querySelector('#cancelBtn').onclick = () => {
                document.body.removeChild(modalOverlay);
            };

            modalContent.querySelector('#deleteBtn').onclick = () => {
                if (confirm('Are you sure you want to delete this timetable entry?')) {
                    deleteTimetableEntry(day, startTime, endTime, slotElement);
                    document.body.removeChild(modalOverlay);
                }
            };

            modalContent.querySelector('#saveBtn').onclick = () => {
                const subject = subjectInput.value.trim();
                const room = modalContent.querySelector('#roomInput').value.trim();
                const batch = modalContent.querySelector('#batchInput').value.trim();

                if (subject) {
                    saveTimetableEntry(day, startTime, endTime, subject, room, batch, slotElement);
                } else {
                    alert('Please enter a subject name.');
                    return;
                }
                document.body.removeChild(modalOverlay);
            };

            // Close on overlay click
            modalOverlay.onclick = (e) => {
                if (e.target === modalOverlay) {
                    document.body.removeChild(modalOverlay);
                }
            };

            // Close on Escape key
            const handleEscape = (e) => {
                if (e.key === 'Escape') {
                    document.body.removeChild(modalOverlay);
                    document.removeEventListener('keydown', handleEscape);
                }
            };
            document.addEventListener('keydown', handleEscape);
        }

        function saveTimetableEntry(day, startTime, endTime, subject, room, batch, slotElement) {
            const timetableEntry = {
                staffId: currentStaff.id,
                day: day,
                timeSlot: {
                    start: startTime,
                    end: endTime
                },
                activity: 'Teaching',
                subject: subject,
                room: room,
                batch: batch,
                semester: '',
                notes: '',
                isRecurring: true
            };

            socket.emit('add_timetable_entry', timetableEntry);
            showNotification('Timetable entry saved successfully!', 'success');
        }

        function deleteTimetableEntry(day, startTime, endTime, slotElement) {
            // Find and delete the entry
            socket.emit('delete_timetable_entry', {
                staffId: currentStaff.id,
                day: day,
                timeSlot: { start: startTime, end: endTime }
            });
            showNotification('Timetable entry deleted!', 'info');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10001;
                animation: slideIn 0.3s ease;
            `;

            const colors = {
                success: '#48bb78',
                error: '#e53e3e',
                info: '#4299e1',
                warning: '#ed8936'
            };

            notification.style.background = colors[type] || colors.info;
            notification.textContent = message;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        function clearAllTimetableEntries() {
            if (confirm('Are you sure you want to clear all timetable entries? This action cannot be undone.')) {
                if (currentStaff) {
                    socket.emit('clear_all_timetable_entries', { staffId: currentStaff.id });
                    showNotification('All timetable entries cleared!', 'info');
                }
            }
        }

        function addSampleTimetableData() {
            console.log('Adding sample timetable data for testing');
            // Add some sample subjects to make the timetable visible
            const sampleData = [
                { day: 'Monday', time: '8:30-9:25', subject: 'Data Structures' },
                { day: 'Monday', time: '9:25-10:20', subject: 'Algorithms' },
                { day: 'Monday', time: '10:40-11:35', subject: 'Database Systems' },
                { day: 'Tuesday', time: '8:30-9:25', subject: 'Computer Networks' },
                { day: 'Tuesday', time: '9:25-10:20', subject: 'Operating Systems' },
                { day: 'Wednesday', time: '8:30-9:25', subject: 'Software Engineering' },
                { day: 'Wednesday', time: '10:40-11:35', subject: 'Web Development' },
                { day: 'Thursday', time: '9:25-10:20', subject: 'Machine Learning' },
                { day: 'Friday', time: '8:30-9:25', subject: 'Project Work' },
                { day: 'Friday', time: '1:15-2:10', subject: 'Research Seminar' }
            ];

            sampleData.forEach(item => {
                const slot = document.querySelector(`[data-day="${item.day}"][data-time="${item.time}"]`);
                if (slot && !slot.classList.contains('coffee-break') && !slot.classList.contains('lunch-break')) {
                    slot.textContent = item.subject;
                    slot.classList.add('has-subject');
                    slot.title = item.subject;
                }
            });
        }

        function displayTimetableEntries(entries) {
            console.log('Displaying timetable entries:', entries);
            if (!entries || entries.length === 0) {
                console.log('No entries found, clearing slots');
                // Clear all slots except breaks
                clearTimetableSlots();
                // Add some sample data for testing
                addSampleTimetableData();
                return;
            }

            // Clear all slots first
            clearTimetableSlots();

            // Populate slots with actual data
            entries.forEach(entry => {
                const day = entry.day;
                const startTime = entry.timeSlot.start;
                const endTime = entry.timeSlot.end;
                const subject = entry.subject || entry.activity;
                const room = entry.room;
                const batch = entry.batch;
                
                console.log(`Processing entry: ${day} ${startTime}-${endTime} - ${subject}`);
                
                // Find the corresponding slot
                const slot = document.querySelector(`[data-day="${day}"][data-time="${startTime}-${endTime}"]`);
                if (slot && !slot.classList.contains('coffee-break') && !slot.classList.contains('lunch-break')) {
                    // Create enhanced display text
                    let displayText = subject;
                    if (room) displayText += ` (${room})`;
                    if (batch) displayText += ` - ${batch}`;
                    
                    slot.textContent = displayText;
                    slot.classList.add('has-subject');
                    slot.title = `${subject}${room ? ` - ${room}` : ''}${batch ? ` - ${batch}` : ''}`;
                    console.log(`Updated slot: ${day} ${startTime}-${endTime}`);
                } else {
                    console.log(`Slot not found for: ${day} ${startTime}-${endTime}`);
                }
            });
        }

        // Call notification functions
        let currentIncomingCall = null;

        function showCallNotification(callData) {
            currentIncomingCall = callData;
            const notification = document.getElementById('callNotification');
            const callerName = document.getElementById('callerName');
            const callerDetails = document.getElementById('callerDetails');
            
            callerName.textContent = callData.clientName || 'Incoming Call';
            callerDetails.textContent = `From Client (${callData.clientId})`;
            
            notification.classList.remove('hidden');
            
            // Auto-hide after 30 seconds if not answered
            setTimeout(() => {
                if (currentIncomingCall === callData) {
                    hideCallNotification();
                }
            }, 30000);
        }

        function hideCallNotification() {
            const notification = document.getElementById('callNotification');
            notification.classList.add('hidden');
            currentIncomingCall = null;
        }

        function acceptCall() {
            if (currentIncomingCall) {
                socket.emit('call-response', {
                    clientId: currentIncomingCall.clientId,
                    accepted: true,
                    staffEmail: currentStaff.email
                });
                hideCallNotification();
                showNotification('Call accepted!', 'success');
            }
        }

        function declineCall() {
            if (currentIncomingCall) {
                socket.emit('call-response', {
                    clientId: currentIncomingCall.clientId,
                    accepted: false,
                    staffEmail: currentStaff.email
                });
                hideCallNotification();
                showNotification('Call declined', 'info');
            }
        }

        // WebRTC call notification functions
        let currentWebRTCCall = null;

        function showWebRTCCallNotification(callData) {
            currentWebRTCCall = callData;
            const notification = document.getElementById('callNotification');
            const callerName = document.getElementById('callerName');
            const callerDetails = document.getElementById('callerDetails');
            
            callerName.textContent = `WebRTC Call - ${callData.clientName}`;
            callerDetails.textContent = `Call ID: ${callData.callId}`;
            
            notification.classList.remove('hidden');
            
            // Auto-hide after 30 seconds if not answered
            setTimeout(() => {
                if (currentWebRTCCall === callData) {
                    hideCallNotification();
                }
            }, 30000);
        }

        function acceptWebRTCCall() {
            if (currentWebRTCCall) {
                console.log('üé• Accepting WebRTC call:', currentWebRTCCall);
                
                socket.emit('webrtc-call-response', {
                    callId: currentWebRTCCall.callId,
                    accepted: true,
                    staffEmail: currentStaff.email
                });
                
                // Add call update
                addCallUpdate({
                    type: 'webrtc-call-response',
                    callId: currentWebRTCCall.callId,
                    clientName: currentWebRTCCall.clientName,
                    clientId: currentWebRTCCall.clientId,
                    status: 'accepted',
                    timestamp: new Date()
                });
                
                // Show GMeet-style video call interface
                showVideoCallInterface(currentWebRTCCall);
                
                hideCallNotification();
                showNotification('WebRTC call accepted!', 'success');
            } else {
                console.error('‚ùå No current WebRTC call to accept');
            }
        }

        function declineWebRTCCall() {
            if (currentWebRTCCall) {
                socket.emit('webrtc-call-response', {
                    callId: currentWebRTCCall.callId,
                    accepted: false,
                    staffEmail: currentStaff.email
                });
                
                // Add call update
                addCallUpdate({
                    type: 'webrtc-call-response',
                    callId: currentWebRTCCall.callId,
                    clientName: currentWebRTCCall.clientName,
                    clientId: currentWebRTCCall.clientId,
                    status: 'declined',
                    timestamp: new Date()
                });
                
                hideCallNotification();
                showNotification('WebRTC call declined', 'info');
            }
        }

        // Universal call handlers that work for both regular and WebRTC calls
        function handleCallAccept() {
            if (currentWebRTCCall) {
                acceptWebRTCCall();
            } else if (currentIncomingCall) {
                acceptCall();
            }
        }

        function handleCallDecline() {
            if (currentWebRTCCall) {
                declineWebRTCCall();
            } else if (currentIncomingCall) {
                declineCall();
            }
        }

        // Add call update to the call updates container
        function addCallUpdate(updateData) {
            console.log('üìû Adding call update:', updateData);
            const callUpdatesList = document.getElementById('callUpdatesList');
            
            if (!callUpdatesList) {
                console.error('‚ùå Call updates list not found!');
                return;
            }
            
            // Remove the "no updates" message if it exists
            const noUpdatesMsg = callUpdatesList.querySelector('div[style*="text-align: center"]');
            if (noUpdatesMsg) {
                console.log('üìû Removing "no updates" message');
                noUpdatesMsg.remove();
            }
            
            // Create call update item
            const updateItem = document.createElement('div');
            updateItem.className = 'call-update-item';
            
            let iconClass = 'incoming';
            let iconSymbol = 'üìû';
            let title = 'Incoming Call';
            let details = `From: ${updateData.clientName}`;
            
            if (updateData.type === 'webrtc-call-request') {
                iconClass = 'incoming';
                iconSymbol = 'üé•';
                title = 'WebRTC Call Request';
                details = `From: ${updateData.clientName} (${updateData.clientId})`;
            } else if (updateData.status === 'accepted') {
                iconClass = 'accepted';
                iconSymbol = '‚úÖ';
                title = 'Call Accepted';
                details = `Connected with: ${updateData.clientName}`;
            } else if (updateData.status === 'declined') {
                iconClass = 'declined';
                iconSymbol = '‚ùå';
                title = 'Call Declined';
                details = `Declined by: ${updateData.clientName}`;
            } else if (updateData.status === 'ended') {
                iconClass = 'declined';
                iconSymbol = 'üîö';
                title = 'Call Ended';
                details = `Call ended with: ${updateData.clientName}`;
            }
            
            const time = new Date(updateData.timestamp).toLocaleTimeString();
            
            updateItem.innerHTML = `
                <div class="call-update-icon ${iconClass}">
                    ${iconSymbol}
                </div>
                <div class="call-update-content">
                    <div class="call-update-title">${title}</div>
                    <div class="call-update-details">${details}</div>
                    <div class="call-update-time">${time}</div>
                </div>
            `;
            
            // Add to the top of the list
            callUpdatesList.insertBefore(updateItem, callUpdatesList.firstChild);
            
            // Limit to 10 items
            const items = callUpdatesList.querySelectorAll('.call-update-item');
            if (items.length > 10) {
                items[items.length - 1].remove();
            }
            
            console.log('üìû Call update added successfully');
        }

        // GMeet-style video call functions
        let localStream = null;
        let remoteStream = null;
        let peerConnection = null;
        let currentCall = null;
        let isMuted = false;
        let isVideoEnabled = true;

        function showVideoCallInterface(callData) {
            console.log('üé• Showing GMeet-style video call interface:', callData);
            
            const videoInterface = document.getElementById('videoCallInterface');
            if (videoInterface) {
                videoInterface.style.display = 'block';
                currentCall = callData;
                try {
                    // Standardize to use callId consistently
                    const callId = currentCall?.callId || currentCall?.id;
                    if (callId) {
                        socket.emit('join_call', { callId });
                        currentCall.callId = callId;
                        currentCall.id = callId; // Keep both for compatibility
                    }
                } catch (_) {}
                
                // Initialize video call
                initializeVideoCall();
            }
        }

        async function initializeVideoCall() {
            try {
                console.log('üé• Initializing video call for staff');
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: { 
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });
                
                // Configure video elements
                configureVideoElements();
                
                // Update local video
                updateLocalVideo();
                
                // Setup peer connection
                initializePeerConnection(localStream);
                
                // Initialize call controls
                initializeCallControls();
                
                console.log('‚úÖ Video call initialized');
            } catch (error) {
                console.error('‚ùå Error initializing video call:', error);
            }
        }

        function configureVideoElements() {
            const localVideo = document.getElementById('localVideo');
            const remoteVideo = document.getElementById('remoteVideo');
            
            if (localVideo) {
                localVideo.setAttribute('playsinline', 'true');
                localVideo.setAttribute('autoplay', 'true');
                localVideo.setAttribute('muted', 'true');
                localVideo.style.objectFit = 'cover';
            }
            
            if (remoteVideo) {
                remoteVideo.setAttribute('playsinline', 'true');
                remoteVideo.setAttribute('autoplay', 'true');
                remoteVideo.style.objectFit = 'cover';
            }
        }

        function updateLocalVideo() {
            const localVideo = document.getElementById('localVideo');
            if (localVideo && localStream) {
                localVideo.srcObject = localStream;
                localVideo.play().then(() => {
                    const localPlaceholder = document.getElementById('localPlaceholder');
                    if (localPlaceholder) {
                        localPlaceholder.style.display = 'none';
                    }
                }).catch(error => {
                    console.warn('‚ö†Ô∏è Local video play failed:', error);
                });
            }
        }

        function updateRemoteVideo() {
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo && remoteStream) {
                remoteVideo.srcObject = remoteStream;
                remoteVideo.play().then(() => {
                    const remotePlaceholder = document.getElementById('remotePlaceholder');
                    if (remotePlaceholder) {
                        remotePlaceholder.style.display = 'none';
                    }
                    
                    const connectingOverlay = document.getElementById('connectingOverlay');
                    if (connectingOverlay) {
                        connectingOverlay.style.display = 'none';
                    }
                }).catch(error => {
                    console.warn('‚ö†Ô∏è Remote video play failed:', error);
                });
            }
        }

        function initializePeerConnection(localStream) {
            try {
                peerConnection = new RTCPeerConnection({
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' }
                    ]
                });
                
                // Add local stream
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });
                
                // Handle remote stream
                peerConnection.ontrack = (event) => {
                    console.log('üì∫ Remote stream received:', event);
                    const remoteVideo = document.getElementById('remoteVideo');
                    if (remoteVideo && event.streams[0]) {
                        remoteStream = event.streams[0];
                        remoteVideo.srcObject = remoteStream;
                        updateRemoteVideo();
                    }
                };
                
                // Handle ICE candidates
                peerConnection.onicecandidate = (event) => {
                    if (event.candidate) {
                        socket.emit('ice_candidate', {
                            callId: currentCall?.callId || currentCall?.id,
                            candidate: event.candidate
                        });
                    }
                };

                // Fallback: if no remote stream within 1.5s, request a fresh offer
                setTimeout(() => {
                    const callRoomId = currentCall?.callId || currentCall?.id;
                    if (!remoteStream && callRoomId) {
                        console.log('üîÑ No remote stream yet, requesting fresh offer for', callRoomId);
                        socket.emit('request_offer', { callId: callRoomId });
                    } else if (!remoteStream) {
                        console.warn('‚ö†Ô∏è Cannot request offer: missing callId');
                    }
                }, 1500);
            } catch (error) {
                console.error('‚ùå Error initializing peer connection:', error);
            }
        }

        function initializeCallControls() {
            isMuted = false;
            isVideoEnabled = true;
            updateControlButtons();
        }

        function updateControlButtons() {
            const muteBtn = document.getElementById('muteBtn');
            const videoBtn = document.getElementById('videoBtn');
            
            if (muteBtn) {
                muteBtn.innerHTML = isMuted ? 
                    '<span class="btn-icon">üîá</span><span class="btn-label">Unmute</span>' :
                    '<span class="btn-icon">üé§</span><span class="btn-label">Mute</span>';
                muteBtn.className = `control-btn mute-btn ${isMuted ? 'muted' : ''}`;
            }
            
            if (videoBtn) {
                videoBtn.innerHTML = isVideoEnabled ? 
                    '<span class="btn-icon">üé•</span><span class="btn-label">Video</span>' :
                    '<span class="btn-icon">üìπ</span><span class="btn-label">Enable</span>';
                videoBtn.className = `control-btn video-btn ${!isVideoEnabled ? 'disabled' : ''}`;
            }
        }

        function toggleMute() {
            console.log('üé§ Toggling mute');
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isMuted = !audioTrack.enabled;
                    updateControlButtons();
                    console.log(isMuted ? 'üîá Audio muted' : 'üé§ Audio unmuted');
                }
            }
        }

        function toggleVideo() {
            console.log('üé• Toggling video');
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isVideoEnabled = videoTrack.enabled;
                    updateControlButtons();
                    console.log(isVideoEnabled ? 'üé• Video enabled' : 'üìπ Video disabled');
                }
            }
        }

        function endVideoCall() {
            console.log('üìû Ending video call');
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            // Close peer connection
            if (peerConnection) {
                peerConnection.close();
            }
            
            // Hide video interface
            const videoInterface = document.getElementById('videoCallInterface');
            if (videoInterface) {
                videoInterface.style.display = 'none';
            }
            
            // Reset states
            localStream = null;
            remoteStream = null;
            peerConnection = null;
            currentCall = null;
            
            console.log('‚úÖ Video call ended');
        }

        // Initialize timetable click handlers when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(setupTimetableClickHandlers, 1000);
        });
    </script>

    <!-- iOS-style Call Notification -->
    <div id="callNotification" class="call-notification hidden">
        <div class="call-notification-content">
            <div class="call-notification-header">
                <div class="caller-avatar">üìû</div>
                <div class="caller-info">
                    <h3 id="callerName">Incoming Call</h3>
                    <p id="callerDetails">From Client</p>
                </div>
            </div>
            <div class="call-notification-actions">
                <button class="call-btn decline" onclick="handleCallDecline()">
                    <i class="fas fa-phone-slash"></i>
                </button>
                <button class="call-btn accept" onclick="handleCallAccept()">
                    <i class="fas fa-phone"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- GMeet-Style Video Call Interface -->
    <div id="videoCallInterface" class="video-call-overlay" style="display: none;">
        <div class="video-call-container">
            <div class="video-call-header">
                <div class="call-info">
                    <h3>üìπ Video Call with Client</h3>
                    <span class="call-status" id="callStatus">Connecting...</span>
                </div>
                <button class="close-video-call" onclick="endVideoCall()" title="Close Call">
                    ‚úï
                </button>
            </div>
            
            <div class="video-call-content">
                <!-- Main video grid - GMeet style -->
                <div class="video-grid">
                    <!-- Remote video (main) -->
                    <div class="remote-video-container main-video">
                        <video id="remoteVideo" autoplay playsinline></video>
                        <div class="video-info">
                            <span class="caller-name">Client</span>
                            <span class="video-label">Remote</span>
                </div>
                        <div class="video-placeholder" id="remotePlaceholder">
                            <div class="placeholder-icon">üë§</div>
                            <div class="placeholder-text">Waiting for client...</div>
                        </div>
                    </div>
                    
                    <!-- Local video (picture-in-picture) -->
                    <div class="local-video-container pip-video">
                        <video id="localVideo" autoplay playsinline muted></video>
                        <div class="video-info">
                            <span class="caller-name">You</span>
                            <span class="video-label">Local</span>
                        </div>
                        <div class="video-placeholder" id="localPlaceholder">
                            <div class="placeholder-icon">üë§</div>
                            <div class="placeholder-text">Your video</div>
                        </div>
                    </div>
                </div>
                
                <!-- Control bar - GMeet style -->
                <div class="video-controls">
                    <button class="control-btn mute-btn" id="muteBtn" onclick="toggleMute()" title="Mute/Unmute">
                        <span class="btn-icon">üé§</span>
                        <span class="btn-label">Mute</span>
                    </button>
                    <button class="control-btn video-btn" id="videoBtn" onclick="toggleVideo()" title="Turn Video On/Off">
                        <span class="btn-icon">üé•</span>
                        <span class="btn-label">Video</span>
                    </button>
                    <button class="control-btn end-call-btn" onclick="endVideoCall()" title="End Call">
                        <span class="btn-icon">üìû</span>
                        <span class="btn-label">End Call</span>
                    </button>
                </div>
                
                <!-- Connecting overlay -->
                <div class="connecting-overlay" id="connectingOverlay">
                    <div class="spinner"></div>
                    <div class="connecting-text">Connecting to client...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Component Scripts -->
    <script src="/utils/socket.js"></script>
    <script src="/hooks/useWebRTC.js"></script>
    <script src="/components/CallUpdatesWidget.jsx"></script>
    <script src="/components/CallUpdates.jsx"></script>
    <script src="/components/CallUpdatesContainer.js"></script>
    <script src="/components/SessionWebRTCManager.js"></script>
    <script src="/components/SessionManager.js"></script>
    <script src="/components/SessionCallNotification.js"></script>
    <script src="/components/SessionVideoCall.js"></script>
</body>
</html>
